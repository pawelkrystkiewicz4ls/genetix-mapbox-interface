<html>
<head>
<meta charset=utf-8 />
  <title>Genetix Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox.js/v3.2.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.2.0/mapbox.css' rel='stylesheet' />
<!-- <link href='index.css' rel='stylesheet' /> -->
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v1.0.0/leaflet.markercluster.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v1.0.0/MarkerCluster.css' rel='stylesheet' />
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v1.0.0/MarkerCluster.Default.css'
  rel='stylesheet' />
<style>
body {
	margin: 0;
	padding: 0;
}

#map  {
	position: absolute;
	top: 0;
	bottom: 0;
	width: 100%;
}
#canvas{
	height:100vh;
	width: 100vw;
}
/* whole DIV wrapping content of popup */
.genetix-popup {

}
/* header of popup contents */
.genetix-popup--header {
	color: red;
	margin-top: 0;
	margin-bottom: 0;
}

/* highligthing values like weight or volume */
.genetix-popup--values {
	color: blue;
}

/* highlighting delivery dates */
.genetix-popup--dates {
	color: purple;
}
.home-button {
	position: absolute;
	border: 2px solid rgba(0, 0, 0, .35);
	border-radius: 3px;
	box-shadow: none;
	background-attachment: fixed;
	background-position: center;
	background-color: #fff;
	display: block;
	right: 10px;
	top: 70px;
	width: 26px;
	height: 26px;
}
.home-button:hover {
	background-color: rgb(247, 244, 244);
}
.clear-button {
	position: absolute;
	border: 2px solid rgba(0, 0, 0, .35);
	border-radius: 3px;
	box-shadow: none;
	background-attachment: fixed;
	background-position: center;
	background-color: #fff;
	display: block;
	right: 10px;
	top: 103px;
	width: 26px;
	height: 26px;
}
.clear-button:hover {
	background-color: rgb(247, 244, 244);
}
.my-div-icon {
	height: 0px;
	width: 0px;
}
pre.ui-coordinates {
  background:rgba(0,0,0,0.5);
  position:absolute;
  bottom:60px;
  left:10px;
  padding:5px 10px;
  color:#fff;
  font-size:11px;
  line-height:18px;
  border-radius:3px;
  max-height:240px;
	min-height:25px;
  overflow:auto;
  width:100px;
  }
pre.box {
  background:rgba(0,0,0,0.5);
  position:absolute;
  top:10px;
  left:10px;
  padding:5px 10px;
  color:#fff;
  font-size:11px;
  line-height:18px;
  border-radius:3px;
  max-height:240px;
	min-height:25px;
	min-width: 300px;
  }

	.boxdraw {
		pointer-events: none;
background: rgba(56,135,190,0.1);
border: 2px solid #3887be;
position: absolute;
top: 0;
left: 0;
width: 0;
height: 0;
}
</style>
</head>
	<body>
		<div id='map'></div>
		<pre id='coordinates' class='ui-coordinates'></pre>
		<pre id='box' class='box'></pre>
		<div class="boxdraw" id='boxdraw'></div>
<svg  class="home-button"  onclick="getViewBounds()" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="expand" class="svg-inline--fa fa-expand fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 180V56c0-13.3 10.7-24 24-24h124c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H64v84c0 6.6-5.4 12-12 12H12c-6.6 0-12-5.4-12-12zM288 44v40c0 6.6 5.4 12 12 12h84v84c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12V56c0-13.3-10.7-24-24-24H300c-6.6 0-12 5.4-12 12zm148 276h-40c-6.6 0-12 5.4-12 12v84h-84c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h124c13.3 0 24-10.7 24-24V332c0-6.6-5.4-12-12-12zM160 468v-40c0-6.6-5.4-12-12-12H64v-84c0-6.6-5.4-12-12-12H12c-6.6 0-12 5.4-12 12v124c0 13.3 10.7 24 24 24h124c6.6 0 12-5.4 12-12z"></path></svg>
<svg class="clear-button"  onclick="clearSelection()" aria-hidden="true" focusable="false" data-prefix="far" data-icon="trash-alt" class="svg-inline--fa fa-trash-alt fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M268 416h24a12 12 0 0 0 12-12V188a12 12 0 0 0-12-12h-24a12 12 0 0 0-12 12v216a12 12 0 0 0 12 12zM432 80h-82.41l-34-56.7A48 48 0 0 0 274.41 0H173.59a48 48 0 0 0-41.16 23.3L98.41 80H16A16 16 0 0 0 0 96v16a16 16 0 0 0 16 16h16v336a48 48 0 0 0 48 48h288a48 48 0 0 0 48-48V128h16a16 16 0 0 0 16-16V96a16 16 0 0 0-16-16zM171.84 50.91A6 6 0 0 1 177 48h94a6 6 0 0 1 5.15 2.91L293.61 80H154.39zM368 464H80V128h288zm-212-48h24a12 12 0 0 0 12-12V188a12 12 0 0 0-12-12h-24a12 12 0 0 0-12 12v216a12 12 0 0 0 12 12z"></path></svg>

<script type="text/javascript">
const yellow = '#E3B505';
const blue = '#2677BD';
const mapboxBlue = '#3544FE';
const green = '#2ecc71';
const orange = '#e67e22';
const purple = '#D27AFF';

const ENABLE_ADJUSTING_MAP_VIEW_MIDDLE_CLICK = true;

L.mapbox.accessToken =
	'pk.eyJ1IjoicGF3ZWxrcnlzdGtpZXdpY3o0bHMiLCJhIjoiY2p0enFrNDJ1Mm9oYTQ1cW4xeXV3aWsyciJ9.eR3LT4VJppS8DpdaNCQZ2w';
//GET CURRENT VIEW ON MIDDLE CLICK
document.addEventListener('DOMContentLoaded', (event) => {
	if (ENABLE_ADJUSTING_MAP_VIEW_MIDDLE_CLICK) {
		const mapDIV = document.querySelector('#map');
		mapDIV.addEventListener('mouseup', (e) => {
			if (typeof e === 'object' && e.button === 1) {
				getViewBounds();
			}
		});
	}
});

const map = L.mapbox
	.map('map', null, { zoomControl: false, })
	.setView([ 0, 0 ], 3)
	.addLayer(L.mapbox.styleLayer('mapbox://styles/mapbox/streets-v11'))
	// .dragPan.disable();	// Disable default drag zooming when the shift key is held down.

new L.Control.Zoom({ position: 'topright' }).addTo(map);
L.control.scale().addTo(map);
// let markersLayer = L.mapbox.featureLayer({ type: 'FeatureCollection', features: [] }); //.addTo(map);
const initiateMarkersLayer = () => L.mapbox.featureLayer({ type: 'FeatureCollection', features: [] }); //.addTo(map);
const initiateRouteLayer = () => L.mapbox.featureLayer({ type: 'FeatureCollection', features: [] }); //.addTo(map);
const initiateClusterGroup = () =>
	new L.MarkerClusterGroup({
		polygonOptions: {
			fillColor: '#3887be',
			color: '#3887be',
			weight: 2,
			opacity: 1,
			fillOpacity: 0.5
		}
	});
const initiateSelectionBox=(start, end)=>new L.LatLngBounds(start, end)
const initiateSelectionStart=()=>new Array(2)
const initMouseStart=()=>({x:null,y:null})
let markersLayer = initiateMarkersLayer();
let routeLayer = initiateRouteLayer();
let clusterGroup = initiateClusterGroup();
let selectionBox=initiateSelectionBox();
let selectedMarkers=new Array()
let tempSelectedMarkers=new Array()
let start=initiateSelectionStart()
let startMouse=initMouseStart()
// let boxdraw=document.getElementById('boxdraw')
//RESET MAP VIEW 0,0
const resetView = () => {
	map.setView([ 0, 0 ], 3);
};

const addGeoJSONMarkers = (features = null) => {
	removeAndRestartLayer();

	if (!!features) {
		markersLayer = initiateMarkersLayer();
		clusterGroup = initiateClusterGroup();
		markersLayer.setGeoJSON({ type: 'FeatureCollection', features });

		// fit to bounds
		map.fitBounds(markersLayer.getBounds());

		markersLayer.eachLayer((layer) => {
			layer.bindPopup(layer.feature.properties.description, { closeButton: false });
		});
		markersLayer.eachLayer(function(layer) {
			clusterGroup.addLayer(layer);
		});

		/**MARKERS EVENTS START */
		markersLayer.on('mouseover', function(e) {
			e.layer.openPopup();
		});
		markersLayer.on('mouseout', function(e) {
			e.layer.closePopup();
		});

		markersLayer.on('click', function(e) {
			map.panTo(e.layer.getLatLng());
		});
		/**MARKER EVENTS END */
		map.addLayer(clusterGroup);
	}
};

const addGeoJSONRoute = (features = null) => {
	removeAndRestartLayer();

	if (!!features) {
		routeLayer.setGeoJSON({ type: 'FeatureCollection', features });

		// fit to bounds
		map.fitBounds(routeLayer.getBounds());

		routeLayer.eachLayer((layer) => {
			if (layer.feature.geometry.type === 'Point') {
				layer.bindPopup(layer.feature.properties.description, { closeButton: false });

				//ADD CUSTOM ICON FOR POINTS ON ROUTE
				const markerHtmlStyles = `
					background-color: ${layer.feature.properties['marker-color']};
					color: ${layer.feature.properties['marker-color']};
					position:relative;
					display: block;
					height:15px;
					width:15px;`;

				let newIcon = new L.divIcon({ className: 'my-div-icon', html: `<span style="${markerHtmlStyles}" />` });

				layer.setIcon(newIcon);
			}

			if (layer instanceof L.Polyline) {
				layer.setStyle({
					color: layer.feature.properties.color
				});
			}
		});

		routeLayer.on('mouseover', function(e) {
			if (e.layer.feature.geometry.type === 'Point') {
				e.layer.openPopup();
			}
		});
		routeLayer.on('mouseout', function(e) {
			if (e.layer.feature.geometry.type === 'Point') {
				e.layer.closePopup();
			}
		});

		routeLayer.on('click', function(e) {
			if (e.layer.feature.geometry.type === 'Point') {
				map.panTo(e.layer.getLatLng());
			}
		});

		map.addLayer(routeLayer);
	}
};

/**ADD ROUTE AND MARKERS IN THE SAME TIME */

const addGeoJSONRouteAndMarkers = (route = null, markers = null) => {
	removeAndRestartLayer();
	switch (true) {
		case !!route:
			routeLayer.setGeoJSON({ type: 'FeatureCollection', features: route });

			// fit to bounds

			routeLayer.eachLayer((layer) => {
				if (layer.feature.geometry.type === 'Point') {
					layer.bindPopup(layer.feature.properties.description, { closeButton: false });

					//ADD CUSTOM ICON FOR POINTS ON ROUTE
					const markerHtmlStyles = `
					background-color: ${layer.feature.properties['marker-color']};
					color: ${layer.feature.properties['marker-color']};
					position:relative;
					display: block;
					height:15px;
					width:15px;`;

					let newIcon = new L.divIcon({
						className: 'my-div-icon',
						html: `<span style="${markerHtmlStyles}" />`
					});

					layer.setIcon(newIcon);
				}

				if (layer instanceof L.Polyline) {
					layer.setStyle({
						color: layer.feature.properties.color
					});
				}
			});

			routeLayer.on('mouseover', function(e) {
				if (e.layer.feature.geometry.type === 'Point') {
					e.layer.openPopup();
				}
			});
			routeLayer.on('mouseout', function(e) {
				if (e.layer.feature.geometry.type === 'Point') {
					e.layer.closePopup();
				}
			});

			routeLayer.on('click', function(e) {
				if (e.layer.feature.geometry.type === 'Point') {
					map.panTo(e.layer.getLatLng());
				}
			});

			map.addLayer(routeLayer);

		case !!markers:
			markersLayer = initiateMarkersLayer();
			clusterGroup = initiateClusterGroup();
			markersLayer.setGeoJSON({ type: 'FeatureCollection', features: markers });

			// fit to bounds

			markersLayer.eachLayer((layer) => {
				layer.bindPopup(layer.feature.properties.description, { closeButton: false });
			});
			markersLayer.eachLayer(function(layer) {
				clusterGroup.addLayer(layer);
			});

			/**MARKERS EVENTS START */
			markersLayer.on('mouseover', function(e) {
				e.layer.openPopup();
			});
			markersLayer.on('mouseout', function(e) {
				e.layer.closePopup();
			});

			markersLayer.on('click', function(e) {
				map.panTo(e.layer.getLatLng());
			});
			/**MARKER EVENTS END */
			map.addLayer(clusterGroup);
			break;

	}

	getViewBounds();
};

//SET VIEW TO ACTIVE MARKERS / ROUTE /
const getViewBounds = () => {
	let routeVisible = routeLayer._geojson.features && routeLayer._geojson.features.length > 0;
	let markersVisible = markersLayer._geojson.features && markersLayer._geojson.features.length > 0;

	switch (true) {
		case routeVisible && markersVisible:
			let group = new L.featureGroup([ routeLayer, markersLayer ]);

			map.fitBounds(group.getBounds());
			// map.fitBounds(markersLayer.getBounds());
			break;
		case markersVisible:
			map.fitBounds(markersLayer.getBounds());
			break;
		case routeVisible:
			map.fitBounds(routeLayer.getBounds());
			break;
		// case !!userGPS:
		// 	map.setView(userGPS, 6);
		// 	break;

		default:
			map.setView({ lon: 0, lat: 0 }, 3);
			break;
	}
};

const getViewBoundsById=(id=null,zoom=12,type='marker')=>{
switch (true) {
	case id && type==="marker":
		markersLayer.eachLayer(layer=>{
		switch (true) {
			case layer instanceof L.Polyline && layer.feature.properties.id===id:
			map.fitBounds(layer.getBounds())
				break;
			case layer instanceof L.Marker && layer.feature.properties.id===id:
						map.setView(layer.getLatLng(),zoom)
				break;
		}
	})
		break;
	case id && type==="route":
		routeLayer.eachLayer(layer=>{
			if( layer instanceof L.Polyline && layer.feature.properties.id===id){
				map.fitBounds(layer.getBounds())
			}
		})
	break;
	case id && type==="point":
	routeLayer.eachLayer(layer=>{
		if(layer instanceof L.Marker && layer.feature.properties.id===id){
			map.setView(layer.getLatLng(),zoom)
		}
	})
	break;
	}
};

const removeAndRestartLayer = () => {
	map.removeLayer(routeLayer);
	map.removeLayer(markersLayer);
	map.removeLayer(clusterGroup);

	markersLayer = initiateMarkersLayer();
	routeLayer = initiateRouteLayer();
	clusterGroup = initiateClusterGroup();

	getViewBounds();
};


const onMouseUp=(e)=> {
// Capture xy coordinates

let tempEnd=[e.latlng.lng,e.latlng.lat]
selectionBox=initiateSelectionBox(start, tempEnd)
endSelection();

}

const onKeyDown=(e)=> {
// If the ESC key is pressed
if (e.keyCode === 27) endSelection();
}


const mouseDown=(e)=> {

let isPressedWithShift=!(e.originalEvent.shiftKey && e.originalEvent.button === 0)
// Continue the rest of the function if the shiftkey is pressed.
if (isPressedWithShift) return;
map.boxZoom.disable()


start=initiateSelectionStart()

start=[e.latlng.lat,e.latlng.lng]
startMouse={x:e.originalEvent.clientX, y:e.originalEvent.clientY}

//initiate empty selection geobox
selectionBox=initiateSelectionBox(start, start)

map.on('mousemove', onMouseMove);
map.on('mouseup', onMouseUp);
map.on('keydown', onKeyDown);
}



function endSelection() {
mouseStart=initMouseStart()
// Remove these events now that endSelection has been called.
map.off('mousemove', onMouseMove);
map.off('keydown', onKeyDown);
map.off('mouseup', onMouseUp);

if (boxdraw) {
boxdraw.style.top = 0;
boxdraw.style.left = 0 ;
boxdraw.style.width = 0;
boxdraw.style.height = 0;
}

		if (selectedMarkers.length >= 100) {
			console.log(`Select a smaller number of features, currently: ${selectedMarkers.length}`);
		}

		// tempSelectedMarkers=selectedMarkers;
		// selectedMarkers=new Array();
}


const onMouseMove = (e) => {
// Capture the ongoing xy coordinates

let tempEnd=[e.latlng.lat,e.latlng.lng]

selectionBox=initiateSelectionBox(start, tempEnd)

document.getElementById('box').innerHTML = `SW: ${selectionBox.getSouthWest()}\nNE: ${selectionBox.getNorthEast()}`;

let current= {x:e.originalEvent.clientX,y:e.originalEvent.clientY}

let minX = Math.min(startMouse.x, current.x),
maxX = Math.max(startMouse.x, current.x),
minY = Math.min(startMouse.y, current.y),
maxY = Math.max(startMouse.y, current.y);

boxdraw.style.top=minY+'px';
boxdraw.style.left=minX+'px';
boxdraw.style.width = maxX - minX  + 'px';
boxdraw.style.height = maxY - minY  + 'px';

markersLayer.eachLayer((marker) => {
	let { id } = marker.feature.properties;
	switch (true) {
		case selectionBox.contains(marker.getLatLng()):
			marker.setIcon(L.mapbox.marker.icon({ ...marker.feature.properties,'marker-color': yellow }));

			switch (true) {
				case !selectedMarkers.includes(id):
					selectedMarkers.push(id);
					break;
				case selectedMarkers.includes(id):
					break;
			}
			break;
		case !selectionBox.contains(marker.getLatLng()) && selectedMarkers.includes(id):
			selectedMarkers.splice(selectedMarkers.indexOf(id), 1);
			marker.setIcon(L.mapbox.marker.icon(marker.feature.properties));
			break;
	}
});


    // Display a list of markers.
    document.getElementById('coordinates').innerHTML = selectedMarkers.join('\n');
};

const clearSelection=()=>{
		//empty all selected markers
	  selectedMarkers=new Array()

		//restore default styling to markers
		markersLayer.eachLayer((marker) => {
			marker.setIcon(L.mapbox.marker.icon(marker.feature.properties));
		})

    document.getElementById('coordinates').innerHTML = selectedMarkers.join('\n');

}

const getSelectedMarkers=()=>{
	return selectedMarkers
}

map.on('mousedown',mouseDown)

</script>

</body>
</html>
