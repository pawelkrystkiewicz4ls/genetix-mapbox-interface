<html>
<head>
<meta charset=utf-8 />
  <title>Genetix Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox.js/v3.2.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.2.0/mapbox.css' rel='stylesheet' />
<!-- <link href='index.css' rel='stylesheet' /> -->
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v1.0.0/leaflet.markercluster.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v1.0.0/MarkerCluster.css' rel='stylesheet' />
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v1.0.0/MarkerCluster.Default.css'
  rel='stylesheet' />
<style>
body {
	margin: 0;
	padding: 0;
}

#map {
	position: absolute;
	top: 0;
	bottom: 0;
	width: 100%;
}
/* whole DIV wrapping content of popup */
.genetix-popup {

}
/* header of popup contents */
.genetix-popup--header {
	color: red;
	margin-top: 0;
	margin-bottom: 0;
}

/* highligthing values like weight or volume */
.genetix-popup--values {
	color: blue;
}

/* highlighting delivery dates */
.genetix-popup--dates {
	color: purple;
}
.home-button {
	position: absolute;
	border: 2px solid rgba(0, 0, 0, .35);
	border-radius: 3px;
	box-shadow: none;
	background-attachment: fixed;
	background-position: center;
	background-color: #fff;
	display: block;
	right: 10px;
	top: 70px;
	width: 26px;
	height: 26px;
}
.home-button:hover {
	background-color: rgb(247, 244, 244);
}
.my-div-icon {
	height: 0px;
	width: 0px;
}
</style>
</head>
<body>
  <div id='map'></div>

  <!-- <div class="home-button" onclick="getViewBounds()"> -->
<svg  class="home-button"  onclick="getViewBounds()" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="expand" class="svg-inline--fa fa-expand fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 180V56c0-13.3 10.7-24 24-24h124c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H64v84c0 6.6-5.4 12-12 12H12c-6.6 0-12-5.4-12-12zM288 44v40c0 6.6 5.4 12 12 12h84v84c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12V56c0-13.3-10.7-24-24-24H300c-6.6 0-12 5.4-12 12zm148 276h-40c-6.6 0-12 5.4-12 12v84h-84c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h124c13.3 0 24-10.7 24-24V332c0-6.6-5.4-12-12-12zM160 468v-40c0-6.6-5.4-12-12-12H64v-84c0-6.6-5.4-12-12-12H12c-6.6 0-12 5.4-12 12v124c0 13.3 10.7 24 24 24h124c6.6 0 12-5.4 12-12z"></path></svg>
  <!-- </div> -->
<script type="text/javascript">
const yellow = '#E3B505';
const blue = '#2677BD';
const mapboxBlue = '#3544FE';
const green = '#2ecc71';
const orange = '#e67e22';
const purple = '#D27AFF';

const ENABLE_ADJUSTING_MAP_VIEW_MIDDLE_CLICK = true;

L.mapbox.accessToken =
	'pk.eyJ1IjoicGF3ZWxrcnlzdGtpZXdpY3o0bHMiLCJhIjoiY2p0enFrNDJ1Mm9oYTQ1cW4xeXV3aWsyciJ9.eR3LT4VJppS8DpdaNCQZ2w';
//GET CURRENT VIEW ON MIDDLE CLICK
document.addEventListener('DOMContentLoaded', (event) => {
	if (ENABLE_ADJUSTING_MAP_VIEW_MIDDLE_CLICK) {
		const mapDIV = document.querySelector('#map');
		mapDIV.addEventListener('mouseup', (e) => {
			if (typeof e === 'object' && e.button === 1) {
				getViewBounds();
			}
		});
	}
});

const map = L.mapbox
	.map('map', null, { zoomControl: false })
	.setView([ 0, 0 ], 3)
	.addLayer(L.mapbox.styleLayer('mapbox://styles/mapbox/streets-v11'));

new L.Control.Zoom({ position: 'topright' }).addTo(map);
L.control.scale().addTo(map);
// let markersLayer = L.mapbox.featureLayer({ type: 'FeatureCollection', features: [] }); //.addTo(map);
const initiateMarkersLayer = () => L.mapbox.featureLayer({ type: 'FeatureCollection', features: [] }); //.addTo(map);
const initiateRouteLayer = () => L.mapbox.featureLayer({ type: 'FeatureCollection', features: [] }); //.addTo(map);
const initiateClusterGroup = () =>
	new L.MarkerClusterGroup({
		polygonOptions: {
			fillColor: '#3887be',
			color: '#3887be',
			weight: 2,
			opacity: 1,
			fillOpacity: 0.5
		}
	});

let markersLayer = initiateMarkersLayer();
let routeLayer = initiateRouteLayer();
let clusterGroup = initiateClusterGroup();
//RESET MAP VIEW 0,0
const resetView = () => {
	map.setView([ 0, 0 ], 3);
};

const addGeoJSONMarkers = (features = null) => {
	removeAndRestartLayer();

	if (!!features) {
		markersLayer = initiateMarkersLayer();
		clusterGroup = initiateClusterGroup();
		markersLayer.setGeoJSON({ type: 'FeatureCollection', features });

		// fit to bounds
		map.fitBounds(markersLayer.getBounds());

		markersLayer.eachLayer((layer) => {
			layer.bindPopup(layer.feature.properties.description, { closeButton: false });
		});
		markersLayer.eachLayer(function(layer) {
			clusterGroup.addLayer(layer);
		});

		/**MARKERS EVENTS START */
		markersLayer.on('mouseover', function(e) {
			e.layer.openPopup();
		});
		markersLayer.on('mouseout', function(e) {
			e.layer.closePopup();
		});

		markersLayer.on('click', function(e) {
			map.panTo(e.layer.getLatLng());
		});
		/**MARKER EVENTS END */
		map.addLayer(clusterGroup);
	}
};

const addGeoJSONRoute = (features = null) => {
	removeAndRestartLayer();

	if (!!features) {
		routeLayer.setGeoJSON({ type: 'FeatureCollection', features });

		// fit to bounds
		map.fitBounds(routeLayer.getBounds());

		routeLayer.eachLayer((layer) => {
			if (layer.feature.geometry.type === 'Point') {
				layer.bindPopup(layer.feature.properties.description, { closeButton: false });

				//ADD CUSTOM ICON FOR POINTS ON ROUTE
				const markerHtmlStyles = `
					background-color: ${layer.feature.properties['marker-color']};
					color: ${layer.feature.properties['marker-color']};
					position:relative;
					display: block;
					height:15px;
					width:15px;`;

				let newIcon = new L.divIcon({ className: 'my-div-icon', html: `<span style="${markerHtmlStyles}" />` });

				layer.setIcon(newIcon);
			}

			if (layer instanceof L.Polyline) {
				layer.setStyle({
					color: layer.feature.properties.color
				});
			}
		});

		routeLayer.on('mouseover', function(e) {
			if (e.layer.feature.geometry.type === 'Point') {
				e.layer.openPopup();
			}
		});
		routeLayer.on('mouseout', function(e) {
			if (e.layer.feature.geometry.type === 'Point') {
				e.layer.closePopup();
			}
		});

		routeLayer.on('click', function(e) {
			if (e.layer.feature.geometry.type === 'Point') {
				map.panTo(e.layer.getLatLng());
			}
		});

		map.addLayer(routeLayer);
	}
};

/**ADD ROUTE AND MARKERS IN THE SAME TIME */

const addGeoJSONRouteAndMarkers = (route = null, markers = null) => {
	removeAndRestartLayer();
	switch (true) {
		case !!route:
			routeLayer.setGeoJSON({ type: 'FeatureCollection', features: route });

			// fit to bounds

			routeLayer.eachLayer((layer) => {
				if (layer.feature.geometry.type === 'Point') {
					layer.bindPopup(layer.feature.properties.description, { closeButton: false });

					//ADD CUSTOM ICON FOR POINTS ON ROUTE
					const markerHtmlStyles = `
					background-color: ${layer.feature.properties['marker-color']};
					color: ${layer.feature.properties['marker-color']};
					position:relative;
					display: block;
					height:15px;
					width:15px;`;

					let newIcon = new L.divIcon({
						className: 'my-div-icon',
						html: `<span style="${markerHtmlStyles}" />`
					});

					layer.setIcon(newIcon);
				}

				if (layer instanceof L.Polyline) {
					layer.setStyle({
						color: layer.feature.properties.color
					});
				}
			});

			routeLayer.on('mouseover', function(e) {
				if (e.layer.feature.geometry.type === 'Point') {
					e.layer.openPopup();
				}
			});
			routeLayer.on('mouseout', function(e) {
				if (e.layer.feature.geometry.type === 'Point') {
					e.layer.closePopup();
				}
			});

			routeLayer.on('click', function(e) {
				if (e.layer.feature.geometry.type === 'Point') {
					map.panTo(e.layer.getLatLng());
				}
			});

			map.addLayer(routeLayer);

		case !!markers:
			markersLayer = initiateMarkersLayer();
			clusterGroup = initiateClusterGroup();
			markersLayer.setGeoJSON({ type: 'FeatureCollection', features: markers });

			// fit to bounds

			markersLayer.eachLayer((layer) => {
				layer.bindPopup(layer.feature.properties.description, { closeButton: false });
			});
			markersLayer.eachLayer(function(layer) {
				clusterGroup.addLayer(layer);
			});

			/**MARKERS EVENTS START */
			markersLayer.on('mouseover', function(e) {
				e.layer.openPopup();
			});
			markersLayer.on('mouseout', function(e) {
				e.layer.closePopup();
			});

			markersLayer.on('click', function(e) {
				map.panTo(e.layer.getLatLng());
			});
			/**MARKER EVENTS END */
			map.addLayer(clusterGroup);
			break;

	}

	getViewBounds();
};

//SET VIEW TO ACTIVE MARKERS / ROUTE /
const getViewBounds = () => {
	let routeVisible = routeLayer._geojson.features && routeLayer._geojson.features.length > 0;
	let markersVisible = markersLayer._geojson.features && markersLayer._geojson.features.length > 0;

	switch (true) {
		case routeVisible && markersVisible:
			let group = new L.featureGroup([ routeLayer, markersLayer ]);

			map.fitBounds(group.getBounds());
			// map.fitBounds(markersLayer.getBounds());
			break;
		case markersVisible:
			map.fitBounds(markersLayer.getBounds());
			break;
		case routeVisible:
			map.fitBounds(routeLayer.getBounds());
			break;
		// case !!userGPS:
		// 	map.setView(userGPS, 6);
		// 	break;

		default:
			map.setView({ lon: 0, lat: 0 }, 3);
			break;
	}
};

const getViewBoundsById=(id=null,zoom=12,type='marker')=>{
switch (true) {
	case id && type==="marker":
		markersLayer.eachLayer(layer=>{
		switch (true) {
			case layer instanceof L.Polyline && layer.feature.properties.id===id:
			map.fitBounds(layer.getBounds())
				break;
			case layer instanceof L.Marker && layer.feature.properties.id===id:
						map.setView(layer.getLatLng(),zoom)
				break;
		}
	})
		break;
	case id && type==="route":
		routeLayer.eachLayer(layer=>{
			if( layer instanceof L.Polyline && layer.feature.properties.id===id){
				map.fitBounds(layer.getBounds())
			}
		})
	break;
	case id && type==="point":
	routeLayer.eachLayer(layer=>{
		if(layer instanceof L.Marker && layer.feature.properties.id===id){
			map.setView(layer.getLatLng(),zoom)
		}
	})
	break;
}
}
const removeAndRestartLayer = () => {
	map.removeLayer(routeLayer);
	map.removeLayer(markersLayer);
	map.removeLayer(clusterGroup);

	markersLayer = initiateMarkersLayer();
	routeLayer = initiateRouteLayer();
	clusterGroup = initiateClusterGroup();

	getViewBounds();
};


</script>
</body>
</html>
